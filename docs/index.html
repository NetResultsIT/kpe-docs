<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.15.0"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>KPE User Documentation: KPE</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="clipboard.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript" src="cookie.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">KPE User Documentation<span id="projectnumber">&#160;0.1.0</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.15.0 -->
<script type="text/javascript">
$(function() { codefold.init(); });
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',false,false,'search.php','Search',true);
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(function(){initNavTree('index.html','',''); });
</script>
<div id="container">
<div id="doc-content">
<div><div class="header">
  <div class="headertitle"><div class="title">KPE </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>KPE, that stands for <em>Kalliope Phone Engine</em>, is a library that allows a programmer to easily create softphone applications that should interact with Kalliope (<a href="https://www.kalliopepbx.com">https://www.kalliopepbx.com</a>) applications.</p>
<p>The main class of KPE is the KPECoreEngine that includes all the business logic of a "Kalliope-based" Computer-Telephony-Integration (CTI) software. It is basically made up of a CTI engine and a Voip engine. The CTI engine establishes a TLS connection (CTI connection) with Kalliope and, through a proprietary protocol, offers a large set of features. Some of the most relevant ones are:</p><ul>
<li>authenticate on the PBX using the same user credentials to access the Kalliope GUI;</li>
<li>retrieve user data like phonebooks, call list (CDR) or voicemail;</li>
<li>get timely information about other extensions' status (BLF);</li>
<li>depending on the operating mode (described later), it also can either<ul>
<li>get provisioning data to setup a SIP connection for the Voip Engine;</li>
<li>remotely-control a deskphone and receive related call events.</li>
</ul>
</li>
</ul>
<p>The Voip engine, instead, provides an application with SIP phone capabilities, so it can directly make and receive calls. The Voip engine con also be used in a "standalone" fashion, without any CTI connection, in case an application does not need Kalliope CTI features but only wants to behave as a basic SIP phone. To build up a Kalliope CTI complete softphone, instead, a CTI connection to Kalliope is necessary.</p>
<p>KPE can establish a CTI connection to Kalliope that allows the following <b>operating modes</b>:</p><ol type="1">
<li><p class="startli"><b>phone mode</b>, that is used to get provisioning data for Voip engine initialization, as configured Kalliope-side. The most important provisioning information needed by Voip engine is surely a Sip account, often called <b>phone Sip account</b> in this documentation. Once CTI connection is established, Kalliope will search for an available phone Sip account among the ones belonging to user's extension. Such an account is required to be of type</p><ul>
<li><em>KPE fixed</em>, in case app platform is desktop;</li>
<li><em>KPE mobile</em>, in case app platform is mobile.</li>
</ul>
<p class="startli">If an available phone Sip account is found, it is automatically assigned to the device the user is using KPE on, and made available for Voip engine provisioning; from this moment Kalliope will remember this association and will provide the same account for this device unless an explicit disassociation is not requested by the user. If no available phone Sip account is found, instead, the CTI features described above will still be available, but Voip engine will remain unprovisioned until a new KPE Sip account is created ad-hoc Kalliope-side and associated to this client: in fact, KPE offers a set of methods to associate an available phone Sip account, as well as to disassociate it, programmatically. It is important to remember that, once a phone Sip account is associated to a client (device), it is not considered available anymore for other clients of the same user/extension. In addition, KPE provides timely updates on the status of all the Sip accounts that belong to user's extension (not only KPE ones).</p>
</li>
<li><b>remote control mode</b>, that is used to remotely-control deskphones. This operating mode is only available for desktop environment. It enables an application to receive call events related to a remote phone and send commands (get/set DND status, make/answer/cancel/hangup/transfer call and others) to Snom and Yealink deskphones. Last feature requires a proper configuration Kalliope-side. NOTE: from KPE point of view, every phone that has currently registered a Sip account belonging to user's exten is considered a remote phone, exception made for Kalliope CTI softphones (including KPE-based clients). NOTE: in this operating mode, Voip engine will remain switched off.</li>
</ol>
<p>In the following scheme, the main interaction steps of each operating mode are shown, with reference to the wrapper class <a class="el" href="class_kpe_qt.html" title="This is the main class of the KPE to use with the Qt C++ libraries. KpeQt is the main object that inc...">KpeQt</a>, that must be used as a C++/Qt interface to the <span class="tt">KPECoreEngine</span> class (which is not meant to be used directly, in fact). The majority of APIs have an integer return code that can be converted into a human-readable string using the <a class="el" href="class_kpe_qt.html#a8150ef0a086f108efe1566cc98e54cac" title="getErrorMessage returns a human-readable string regarding the passed error code">KpeQt::getErrorMessage()</a> method.</p>
<h4 class="doxsection"><a class="anchor" id="par_phone_mode"></a>
Phone mode</h4>
<p>Once the CTI connection is successfully established, KPE will retrieve information on how to configure the VoIP Engine and then start the SIP registration process. You can look at the following diagram to get an idea of the flow </p><div class="image">
<img src="KPE_Login_1.png" alt=""/>
</div>
<p>In the event of a successful login KPE will retrieve necessary SIP data from the PBX and automatically register to Kalliope and be ready to receive and make SIP calls. You can look at the following diagram to see how this works: </p><div class="image">
<img src="KPE_Login_2.png" alt=""/>
</div>
<p>The life-cycle of a wrapper object should be the following:</p><ol type="1">
<li>Instantiation</li>
<li>Setup of configuration parameters (PBX address, username, operating mode etc.) through <a class="el" href="class_kpe_qt.html#a1aa384763411f89df4f246019a71c17d" title="setLoginData is used to set the fields used for authentication on the CTI connection to the PBX">KpeQt::setLoginData()</a>;</li>
<li>Initializiation of the object via the <a class="el" href="class_kpe_qt.html#aac3e4a8cb6b4e1a0c667b14ec9f813e3" title="This method must be called before the KPE can be succesfully used and after the initial configuration...">KpeQt::init()</a> method;</li>
<li>Handling of SIP-based incoming events (i.e. Incoming calls, remote ringing, etc.);</li>
<li>Generation of SIP-based events;</li>
<li>Shutdown through <a class="el" href="class_kpe_qt.html#a7bff2f6f7a84fd073e9d4724bb0e696b" title="shutdowns the KPE, putting it back in a configuration state">KpeQt::shutdown()</a> (the opposite of <a class="el" href="class_kpe_qt.html#aac3e4a8cb6b4e1a0c667b14ec9f813e3" title="This method must be called before the KPE can be succesfully used and after the initial configuration...">KpeQt::init()</a>);</li>
<li>Object destruction or a new configuration and init phase; You can have a look in the <em>examples</em> subfolder for a simple application that shows this basic behaviour.</li>
</ol>
<h4 class="doxsection"><a class="anchor" id="par_standalone_sip_phone"></a>
"Standalone" Voip engine</h4>
<p>If the programmer does not wish to rely on Kalliope services (automatic SIP provisioning, etc.) and would just use the <em>"basic"</em> SIP functionalities they can manually provide the SIP configuration parameters via the wrapper's methods:</p><ul>
<li><a class="el" href="class_kpe_qt.html#ace06f47e32fa0fb7c959f94b0fb0b662" title="overrideSipRegistrar sets a specific value to be used as SIP registrar (usually the PBX or SBC IP add...">KpeQt::overrideSipRegistrar()</a>;</li>
<li><a class="el" href="class_kpe_qt.html#aee5ace588e25d28f2e1adf71da441c1d" title="overrideSipUser is used to specify the username and password to be used by the VoipEngine for SIP aut...">KpeQt::overrideSipUser()</a>;</li>
<li><a class="el" href="class_kpe_qt.html#a02862480402d179f3583f55916167090" title="useOverriddenParamsForSipProvisioning uses data set by overrideSipUser() and overrideSipRegistrar() m...">KpeQt::useOverriddenParamsForSipProvisioning()</a>.</li>
</ul>
<p>In this case the call flow would be the following:</p>
<div class="image">
<img src="KPE_Override_1.png" alt=""/>
</div>
<h4 class="doxsection"><a class="anchor" id="par_remote_control_mode"></a>
Remote control mode</h4>
<p>Once CTI connection is successfully established, KPE will retrieve information about the Sip accounts (belonging to user's extension) that are currently registered by a remotely-controllable phone. These Sip accounts can be used to send a command to the related Snom/Yealink deskphone. After successful login, the following signals and methods can be used:</p><ul>
<li><a class="el" href="class_kpe_qt.html#ade0fe60f506716b521261622d4f7887b" title="sigSipAccountListUpdated is emitted when the full list of Sip accounts (belonging to user&#39;s exten) is...">KpeQt::sigSipAccountListUpdated()</a>;</li>
<li><a class="el" href="class_kpe_qt.html#a11f1255226369d02b2f8bb54b1cf6448" title="Get the list of Sip accounts belonging to user&#39;s exten.">KpeQt::getSipAccountList()</a>, filtering those related to remotely-controllable phones;</li>
<li><a class="el" href="class_kpe_qt.html#a4e9780e7290f34b1e245236d6062af71" title="Send a command to a remotely-controlled deskphone, through Kalliope.">KpeQt::sendRemotePhoneCommand()</a>;</li>
<li><a class="el" href="class_kpe_qt.html#a4e75c33afece335e6c72718da0a30fc8" title="This signal is emitted after Kalliope received an event from a remote deskphone.">KpeQt::sigRemotePhoneEventReceived()</a>;</li>
</ul>
<p>Related call events will be notified by KPE. Note that, for remote phones that are not remotely-controllable, related call events will be notified as well but, obviously, commands are not allowed with the exception of the request to reject the call via the <a class="el" href="class_kpe_qt.html#a1beb94c5b5a7aed6558ad4a6fdc6f9d2" title="This method requests Kalliope to hangup a call that is handled by a deskphone. If request is successf...">KpeQt::requestCallHangup()</a> API that will refuse the call as a whole (i.e. all phones ringing will stop handling the call).</p>
<p>A basic schema is the following:</p>
<div class="image">
<img src="KPE_Remote_control.png" alt=""/>
</div>
<p>Have fun and happy VoIPing! </p>
</div></div><!-- PageDoc -->
<a href="doxygen_crawl.html"></a>
</div><!-- contents -->
</div><!-- doc-content -->
</div><!-- container -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated on <span class="timestamp"></span> for KPE User Documentation by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.15.0 </li>
  </ul>
</div>
</body>
</html>
